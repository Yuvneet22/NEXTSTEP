{% extends "base.html" %}

{% block title %}Advanced Assessment â€“ Phase 3{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8 relative z-10">

  <!-- Tab Switcher -->
  <div class="flex justify-center mb-6 gap-2">
    <button id="tab-ai" onclick="switchTab('ai')"
      class="tab-btn active-tab flex items-center gap-2 px-6 py-2.5 rounded-full text-sm font-bold transition-all shadow-sm border border-violet-200 bg-violet-600 text-white">
      ðŸ¤– AI Chat Mode
    </button>
    <button id="tab-classic" onclick="switchTab('classic')"
      class="tab-btn flex items-center gap-2 px-6 py-2.5 rounded-full text-sm font-bold transition-all shadow-sm border border-slate-300 bg-white text-slate-600 hover:border-violet-300 hover:text-violet-700">
      ðŸ“‹ Classic Mode
    </button>
  </div>

  <!-- ===================== AI CHAT MODE ===================== -->
  <div id="ai-chat-panel">
    <div class="bg-white/70 backdrop-blur-xl shadow-2xl rounded-3xl overflow-hidden border border-white/50 flex flex-col" style="height:75vh;">

      <!-- Chat Header -->
      <div class="px-6 py-4 bg-gradient-to-r from-violet-600 to-indigo-600 text-white flex items-center justify-between flex-shrink-0">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">ðŸŽ“</div>
          <div>
            <h3 class="font-bold text-base leading-tight">AI Career Counsellor</h3>
            <p class="text-violet-200 text-xs">Phase 3 Â· Deep Dive Â· {{ category_name }}</p>
          </div>
        </div>
        <div id="ai-progress-badge" class="text-xs bg-white/20 px-3 py-1 rounded-full font-bold">
          Scenario <span id="ai-step-counter">0</span> / {{ scenarios|length }}
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="w-full bg-violet-100 h-1.5 flex-shrink-0">
        <div id="ai-progress-bar" class="bg-gradient-to-r from-violet-500 to-indigo-500 h-1.5 transition-all duration-700" style="width:0%"></div>
      </div>

      <!-- Chat Messages -->
      <div id="ai-chat-box" class="flex-grow p-6 overflow-y-auto space-y-4 bg-slate-50/60"></div>

      <!-- Quick Reply Buttons (A/B) -->
      <div id="quick-replies" class="px-6 py-2 flex gap-3 flex-shrink-0 hidden">
        <button onclick="sendQuickReply('A')"
          class="flex-1 py-2.5 rounded-xl border-2 border-violet-300 bg-violet-50 text-violet-700 font-bold text-sm hover:bg-violet-100 active:scale-95 transition-all">
          âœ… Option A
        </button>
        <button onclick="sendQuickReply('B')"
          class="flex-1 py-2.5 rounded-xl border-2 border-indigo-300 bg-indigo-50 text-indigo-700 font-bold text-sm hover:bg-indigo-100 active:scale-95 transition-all">
          âœ… Option B
        </button>
      </div>

      <!-- Finish Button (shown when done) -->
      <div id="finish-container" class="px-6 py-4 hidden flex-shrink-0">
        <form id="ai-submit-form" action="/assessment/phase3/submit" method="POST" id="ai-submit-form">
          <div id="hidden-answers-container"></div>
          <button type="submit"
            class="w-full py-3.5 rounded-2xl text-white font-bold text-base bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 shadow-lg shadow-violet-200/50 transition-all hover:scale-[1.02] flex items-center justify-center gap-3">
            <span id="finish-btn-text">ðŸš€ Finish Assessment</span>
            <div id="finish-spinner" class="hidden">
              <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
            </div>
          </button>
        </form>
      </div>

      <!-- Input Area -->
      <div id="ai-input-area" class="bg-white border-t border-slate-200 px-4 py-3 flex-shrink-0">
        <form id="ai-chat-form" class="flex gap-3 items-center">
          <input type="text" id="ai-user-input"
            class="flex-grow px-4 py-2.5 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-violet-500 text-sm transition-all"
            placeholder="Type 'Option A' or 'Option B' or describe your answer..."
            autocomplete="off">
          <button type="submit" id="ai-send-btn"
            class="bg-violet-600 hover:bg-violet-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition-colors shadow flex items-center gap-2 disabled:opacity-50">
            Send
            <svg class="h-4 w-4 rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- ===================== CLASSIC MODE ===================== -->
  <div id="classic-panel" class="hidden">
    <div class="bg-white/70 backdrop-blur-xl shadow-2xl rounded-3xl overflow-hidden border border-white/50">
        <div class="w-full bg-slate-100 h-2.5 relative overflow-hidden">
            <div id="progress-bar"
                class="bg-gradient-to-r from-violet-500 via-purple-500 to-indigo-600 h-2.5 transition-all duration-700 ease-out relative"
                style="width: 0%">
                <div class="absolute top-0 right-0 bottom-0 w-10 bg-white/40 blur-[4px] -skew-x-12 translate-x-full animate-[shimmer_2s_infinite]"></div>
            </div>
        </div>

        <div class="px-6 py-6 sm:px-8 bg-violet-50 flex justify-between items-center border-b border-violet-100">
            <div>
                <h3 class="text-lg leading-6 font-bold text-violet-900">Phase 3: Deep Dive Scenarios</h3>
                <p class="mt-1 max-w-2xl text-sm text-violet-700 font-medium">
                    Scenario <span id="step-counter" class="font-bold">1</span> of {{ scenarios|length }}
                </p>
            </div>
            <div class="flex space-x-2">
                <button type="button" id="record-btn"
                    class="p-2.5 rounded-full bg-slate-100 text-slate-600 shadow-sm hover:bg-red-50 hover:text-red-600 transition-all border border-slate-200"
                    title="Record Answer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>
                <button type="button" onclick="speakCurrentScenario()"
                    class="p-2.5 rounded-full bg-white text-violet-600 shadow-sm hover:bg-violet-100 transition-colors border border-violet-200"
                    title="Replay Audio">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="px-6 py-8 sm:p-10">
            <form id="scenario-form" action="/assessment/phase3/submit" method="POST">
                {% for scenario in scenarios %}
                <div class="scenario-step hidden space-y-8" data-step="{{ loop.index0 }}">
                    <div class="text-center md:text-left">
                        <h4 class="text-2xl font-extrabold text-slate-900 mb-6 scenario-title tracking-tight">{{ scenario.title }}</h4>
                        <div class="text-lg text-slate-700 mb-8 italic border-l-4 border-violet-300 pl-6 py-4 bg-slate-50 rounded-r-2xl scenario-story shadow-sm">
                            "{{ scenario.story }}"
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        {% for opt in scenario.options %}
                        <label class="option-label relative flex cursor-pointer rounded-2xl border-2 border-slate-200/60 bg-white/80 p-6 shadow-sm transition-all duration-300 hover:shadow-xl hover:shadow-violet-200/50 hover:border-violet-300 hover:-translate-y-2 peer-checked:border-emerald-500 peer-checked:bg-emerald-50/50 group">
                            <input type="radio" name="{{ scenario.id }}" value="{{ opt.value }}" onchange="handleSelection()" class="sr-only peer" required>
                            <span class="flex flex-1">
                                <span class="flex flex-col">
                                    <span class="block text-xs font-bold text-violet-600 uppercase tracking-wider mb-2">Option {{ opt.value }}</span>
                                    <span class="block text-base font-medium text-slate-800 option-text leading-relaxed">{{ opt.text }}</span>
                                </span>
                            </span>
                            <div class="absolute -inset-px rounded-2xl border-2 border-transparent peer-checked:border-violet-600 pointer-events-none ring-0 peer-checked:ring-2 peer-checked:ring-violet-100"></div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

                <div id="final-step" class="hidden text-center py-10">
                    <div class="mb-6 inline-flex items-center justify-center h-24 w-24 rounded-full bg-violet-100 text-violet-600 animate-bounce">
                        <svg class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3 class="text-3xl font-extrabold text-slate-900 mb-2">Scenarios Complete</h3>
                    <p class="text-slate-500 mt-2 mb-10 text-lg">Ready to generate your final work-style profile?</p>
                    <button type="submit" id="finish-btn"
                        class="inline-flex items-center px-10 py-4 border border-transparent text-lg font-bold rounded-2xl shadow-xl shadow-violet-200/50 text-white bg-gradient-to-r from-violet-600 via-purple-600 to-indigo-600 hover:from-violet-500 hover:via-purple-500 hover:to-indigo-500 transform transition-all duration-300 hover:scale-105 hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-violet-300 min-w-[280px] justify-center">
                        <span id="btn-text">Finish Assessment</span>
                        <div id="btn-spinner" class="hidden ml-3">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </button>
                    <p id="loading-text" class="hidden mt-6 text-violet-600 font-bold animate-pulse">Deep Diving into your work-style profile...</p>
                </div>
            </form>
        </div>
    </div>
  </div>
</div>

<!-- Floating AI Buddy Orb -->
<div id="talking-buddy" class="fixed top-24 right-8 z-[100] flex items-center justify-center w-20 h-20 pointer-events-none">
    <div class="pulse-ring absolute inset-0 rounded-full bg-violet-400 opacity-0"></div>
    <div class="pulse-ring absolute inset-0 rounded-full bg-indigo-400 opacity-0" style="animation-delay: 0.5s"></div>
    <div class="buddy-orb relative w-14 h-14 rounded-full bg-gradient-to-br from-violet-600 to-indigo-700 shadow-[0_0_30px_rgba(139,92,246,0.6)] flex items-center justify-center border-2 border-violet-400/30 overflow-hidden">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(255,255,255,0.2),transparent)]"></div>
        <span class="text-3xl z-10">ðŸŽ“</span>
    </div>
    <div id="buddy-status" class="absolute bottom-1 right-1 h-5 w-5 bg-slate-400 rounded-full border-2 border-white shadow-lg z-[110] transition-colors duration-300"></div>
</div>

<!-- Load Marked.js -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
// ==================== TAB SWITCHING ====================
function switchTab(tab) {
    const aiPanel = document.getElementById('ai-chat-panel');
    const classicPanel = document.getElementById('classic-panel');
    const tabAI = document.getElementById('tab-ai');
    const tabClassic = document.getElementById('tab-classic');

    if (tab === 'ai') {
        aiPanel.classList.remove('hidden');
        classicPanel.classList.add('hidden');
        tabAI.classList.add('bg-violet-600', 'text-white', 'border-violet-200');
        tabAI.classList.remove('bg-white', 'text-slate-600', 'border-slate-300');
        tabClassic.classList.remove('bg-violet-600', 'text-white', 'border-violet-200');
        tabClassic.classList.add('bg-white', 'text-slate-600', 'border-slate-300');
    } else {
        classicPanel.classList.remove('hidden');
        aiPanel.classList.add('hidden');
        tabClassic.classList.add('bg-violet-600', 'text-white', 'border-violet-200');
        tabClassic.classList.remove('bg-white', 'text-slate-600', 'border-slate-300');
        tabAI.classList.remove('bg-violet-600', 'text-white', 'border-violet-200');
        tabAI.classList.add('bg-white', 'text-slate-600', 'border-slate-300');
    }
}

// ==================== AI CHAT MODE ====================
const aiChatBox = document.getElementById('ai-chat-box');
const aiChatForm = document.getElementById('ai-chat-form');
const aiUserInput = document.getElementById('ai-user-input');
const aiSendBtn = document.getElementById('ai-send-btn');
const aiProgressBar = document.getElementById('ai-progress-bar');
const aiStepCounter = document.getElementById('ai-step-counter');
const quickReplies = document.getElementById('quick-replies');
const finishContainer = document.getElementById('finish-container');
const aiInputArea = document.getElementById('ai-input-area');
const totalScenarios = {{ scenarios|length }};

// Session state stored client-side
let aiState = { current_index: 0, answers: {} };
let isDone = false;

function appendAIMessage(text, isUser = false) {
    const div = document.createElement('div');
    div.className = `flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''}`;

    const avatar = isUser
        ? `<div class="w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center flex-shrink-0 text-base">ðŸ‘¤</div>`
        : `<div class="w-9 h-9 rounded-full bg-violet-100 flex items-center justify-center flex-shrink-0 text-base border border-violet-200">ðŸŽ“</div>`;

    const bubbleClass = isUser
        ? 'bg-violet-600 text-white rounded-2xl rounded-tr-sm shadow-md'
        : 'bg-white text-slate-700 rounded-2xl rounded-tl-sm shadow-sm border border-slate-200';

    div.innerHTML = `
        ${avatar}
        <div class="${bubbleClass} p-4 max-w-[82%]">
            <div class="prose ${isUser ? 'prose-invert' : 'prose-violet'} max-w-none text-sm leading-relaxed">
                ${marked.parse(text)}
            </div>
        </div>`;

    aiChatBox.appendChild(div);
    aiChatBox.scrollTop = aiChatBox.scrollHeight;
}

function showTypingDot() {
    const div = document.createElement('div');
    div.id = 'typing-dot';
    div.className = 'flex items-start gap-3';
    div.innerHTML = `
        <div class="w-9 h-9 rounded-full bg-violet-100 flex items-center justify-center flex-shrink-0 text-base border border-violet-200">ðŸŽ“</div>
        <div class="bg-white p-4 rounded-2xl rounded-tl-sm shadow-sm border border-slate-200">
            <div class="flex space-x-1.5">
                <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div>
                <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay:0.4s"></div>
            </div>
        </div>`;
    aiChatBox.appendChild(div);
    aiChatBox.scrollTop = aiChatBox.scrollHeight;
}

function removeTypingDot() {
    const el = document.getElementById('typing-dot');
    if (el) el.remove();
}

function updateAIProgress(idx) {
    const pct = (idx / totalScenarios) * 100;
    aiProgressBar.style.width = pct + '%';
    aiStepCounter.textContent = Math.min(idx, totalScenarios);
}

async function callPhase3Chat(message) {
    aiSendBtn.disabled = true;
    aiUserInput.disabled = true;
    quickReplies.classList.add('hidden');
    showTypingDot();

    const buddyStatus = document.getElementById('buddy-status');
    buddyStatus.classList.remove('bg-slate-400');
    buddyStatus.classList.add('bg-green-400', 'shadow-[0_0_8px_#4ade80]');

    try {
        const resp = await fetch('/assessment/phase3/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                current_index: aiState.current_index,
                answers: aiState.answers
            })
        });
        const data = await resp.json();

        removeTypingDot();
        appendAIMessage(data.response, false);

        // Update state
        aiState.current_index = data.current_index;
        aiState.answers = data.answers;
        updateAIProgress(aiState.current_index);
        isDone = data.done;

        if (isDone) {
            // Inject hidden form inputs and show finish button
            rebuildHiddenInputs();
            finishContainer.classList.remove('hidden');
            aiInputArea.classList.add('hidden');
            quickReplies.classList.add('hidden');
        } else {
            quickReplies.classList.remove('hidden');
        }
    } catch (err) {
        removeTypingDot();
        appendAIMessage("I'm having trouble connecting. Please refresh and try again.", false);
    } finally {
        buddyStatus.classList.remove('bg-green-400', 'shadow-[0_0_8px_#4ade80]');
        buddyStatus.classList.add('bg-slate-400');
        aiSendBtn.disabled = false;
        aiUserInput.disabled = false;
        aiUserInput.value = '';
        aiUserInput.focus();
    }
}

function sendQuickReply(opt) {
    if (isDone) return;
    const optionLabel = opt === 'A' ? 'Option A' : 'Option B';
    
    // Record answer for the CURRENT question being answered (current_index - 1 if we already advanced,
    // but since we haven't sent yet, it's the scenario at current_index in the scenarios array)
    const scenarios = {{ scenarios | tojson }};
    const scenarioId = scenarios[aiState.current_index]?.id;
    if (scenarioId) {
        aiState.answers[scenarioId] = opt;
    }

    appendAIMessage(optionLabel, true);
    callPhase3Chat(optionLabel);
}

aiChatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const msg = aiUserInput.value.trim();
    if (!msg || isDone) return;

    // Try to parse A/B from freetext and record answer
    const scenarios = {{ scenarios | tojson }};
    const scenarioId = scenarios[aiState.current_index]?.id;
    if (scenarioId) {
        const upper = msg.toUpperCase();
        if (upper.includes('OPTION A') || upper === 'A') aiState.answers[scenarioId] = 'A';
        else if (upper.includes('OPTION B') || upper === 'B') aiState.answers[scenarioId] = 'B';
        else aiState.answers[scenarioId] = msg; // store freetext
    }

    appendAIMessage(msg, true);
    callPhase3Chat(msg);
});

function rebuildHiddenInputs() {
    const container = document.getElementById('hidden-answers-container');
    container.innerHTML = '';
    for (const [key, value] of Object.entries(aiState.answers)) {
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = key;
        inp.value = value;
        container.appendChild(inp);
    }
}

document.getElementById('ai-submit-form').addEventListener('submit', function() {
    rebuildHiddenInputs();
    document.getElementById('finish-btn-text').textContent = 'Generating Insights...';
    document.getElementById('finish-spinner').classList.remove('hidden');
});

// Auto-start: load first scenario on page load
document.addEventListener('DOMContentLoaded', () => {
    updateAIProgress(0);
    callPhase3Chat('');
});

// ==================== CLASSIC MODE (unchanged) ====================
let currentStep = 0;
const steps = document.querySelectorAll('.scenario-step');
const totalSteps = steps.length;
const progressBar = document.getElementById('progress-bar');
const stepCounter = document.getElementById('step-counter');

function getBestVoice() {
    const voices = window.speechSynthesis.getVoices();
    return voices.find(v => v.lang === 'en-IN') ||
           voices.find(v => v.name.includes('India') || v.name.includes('Indian')) ||
           voices.find(v => v.lang.startsWith('en')) ||
           voices[0];
}

function showStep(index) {
    steps.forEach(s => s.classList.add('hidden'));
    if (index >= totalSteps) {
        document.getElementById('final-step').classList.remove('hidden');
        progressBar.style.width = '100%';
        stepCounter.innerText = totalSteps;
        window.speechSynthesis.cancel();
        return;
    }
    steps[index].classList.remove('hidden');
    stepCounter.innerText = index + 1;
    progressBar.style.width = ((index / totalSteps) * 100) + '%';
    setTimeout(() => speakCurrentScenario(), 600);
}

function handleSelection() {
    setTimeout(() => { currentStep++; showStep(currentStep); }, 500);
}

function speakCurrentScenario() {
    window.speechSynthesis.cancel();
    const stepEl = steps[currentStep];
    if (!stepEl) return;
    const title = stepEl.querySelector('.scenario-title').innerText;
    const story = stepEl.querySelector('.scenario-story').innerText;
    const options = stepEl.querySelectorAll('.option-text');
    let script = `${title}. ${story}. Your options are: `;
    options.forEach((opt, i) => { script += `Option ${i + 1}: ${opt.innerText}. `; });
    const utterance = new SpeechSynthesisUtterance(script);
    utterance.voice = getBestVoice();
    utterance.rate = 0.95;
    utterance.pitch = 1.1;

    // Voice Recording Logic
    let recognition;
    const recordBtn = document.getElementById('record-btn');
    if (('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) && recordBtn && !recordBtn._bound) {
        recordBtn._bound = true;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.onstart = () => { recordBtn.classList.add('bg-red-500', 'text-white', 'animate-pulse'); recordBtn.classList.remove('bg-slate-100', 'text-slate-600'); window.speechSynthesis.cancel(); };
        recognition.onend = () => { recordBtn.classList.remove('bg-red-500', 'text-white', 'animate-pulse'); recordBtn.classList.add('bg-slate-100', 'text-slate-600'); };
        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            const buddySpan = document.getElementById('talking-buddy')?.querySelector('span');
            if (buddySpan) { const orig = buddySpan.innerText; buddySpan.innerText = 'ðŸ¤”'; setTimeout(() => { buddySpan.innerText = orig; }, 3000); }
            try {
                const options = steps[currentStep].querySelectorAll('.option-label');
                const response = await fetch('/assessment/resolve-voice', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ transcript, options: Array.from(options).map(opt => ({ value: opt.querySelector('input').value, text: opt.querySelector('.option-text').innerText })) }) });
                if (response.ok) { const data = await response.json(); const radio = steps[currentStep].querySelector(`input[value="${data.best_match}"]`); if (radio) { radio.checked = true; handleSelection(); } }
            } catch (err) { console.error('Resolution error:', err); }
        };
        recordBtn.addEventListener('click', () => { if (recordBtn.classList.contains('bg-red-500')) { recognition.stop(); } else { recognition.start(); } });
    }
    window.speechSynthesis.speak(utterance);
}

document.getElementById('scenario-form').addEventListener('submit', () => {
    const btn = document.getElementById('finish-btn');
    document.getElementById('btn-text').innerText = 'Generating Insights...';
    document.getElementById('btn-spinner').classList.remove('hidden');
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    document.getElementById('loading-text').classList.remove('hidden');
});

// Init classic mode (but don't show step yet â€” it's hidden by default)
// Steps will show when user switches to Classic tab
</script>
{% endblock %}