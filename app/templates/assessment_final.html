{% extends "base.html" %}

{% block title %}Final Stream Assessment{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-100">
        <!-- Progress Bar -->
        <div class="w-full bg-slate-100 h-2.5">
            <div id="progress-bar"
                class="bg-gradient-to-r from-violet-500 to-indigo-600 h-2.5 transition-all duration-500 ease-out"
                style="width: 0%"></div>
        </div>

        <!-- Header -->
        <div class="px-6 py-6 sm:px-8 flex justify-between items-center bg-slate-50 border-b border-slate-100 relative">
            <div>
                <h3 class="text-xl leading-6 font-bold text-slate-800">Phase 4: Final Stream Recommendation</h3>
                <p class="mt-1 max-w-2xl text-sm text-slate-500 font-medium tracking-wide uppercase">Question <span id="current-step-text"
                        class="text-violet-600 font-bold">1</span> of <span id="total-steps-text">10</span></p>
            </div>
            <button type="button" onclick="speakCurrentQuestion()"
                class="p-3 rounded-full bg-white text-violet-600 shadow-sm border border-slate-200 hover:bg-violet-50 hover:text-violet-700 transition-all transform hover:scale-105"
                title="Read Aloud">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
            </button>
        </div>

        <div class="px-6 py-8 sm:p-10">
            <form id="assessment-form" action="/assessment/final/submit" method="POST">
                <input type="hidden" name="mode" value="{{ mode }}">

                {% if mode == '10th' %}
                    <!-- Class 10th: Stepper questions -->
                    {% set ns = namespace(counter=0) %}
                    {% for section_id, section in sections.items() %}
                        {% for q in section.questions %}
                        <div class="question-step hidden space-y-6" data-step="{{ ns.counter }}">
                            <div class="mb-4">
                                <span class="inline-block px-3 py-1 text-xs font-semibold tracking-wide uppercase text-violet-600 bg-violet-100 rounded-full mb-3">{{ section.title }}</span>
                                <h4 class="text-2xl font-extrabold text-slate-800 mb-2 question-title">{{ q.question }}</h4>
                            </div>

                            <div class="space-y-3">
                                {% for opt in q.options %}
                                <label class="relative flex items-center p-4 rounded-xl border-2 border-slate-200 cursor-pointer hover:border-violet-300 hover:bg-violet-50/30 transition-all duration-200 group">
                                    <input type="radio" name="{{ q.id }}" value="{{ opt.value }}" required
                                        onchange="handleSelection(this)" class="h-5 w-5 text-violet-600 focus:ring-violet-500 border-slate-300">
                                    <span class="ml-4 text-slate-700 font-medium group-hover:text-slate-900 transition-colors">{{ opt.text }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% set ns.counter = ns.counter + 1 %}
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    <!-- Class 12th & Above: Stepper questions with TextArea -->
                    {% for q in questions %}
                    <div class="question-step hidden space-y-6" data-step="{{ loop.index0 }}">
                        <div class="mb-4">
                            <span class="inline-block px-3 py-1 text-xs font-semibold tracking-wide uppercase text-indigo-600 bg-indigo-100 rounded-full mb-3">Scenario {{ loop.index }}</span>
                            <h4 class="text-2xl font-extrabold text-slate-800 mb-2 question-title">{{ q.title }}</h4>
                        </div>
                        <p class="text-slate-600 text-lg italic bg-slate-50 p-4 rounded-xl border border-slate-100 mb-6">"{{ q.text }}"</p>

                        <div class="relative">
                            <label for="{{ q.id }}" class="block text-sm font-medium text-slate-500 mb-2 uppercase tracking-wider">Your Response (Type or Speak)</label>
                            <div class="flex gap-3">
                                <textarea id="{{ q.id }}" name="{{ q.id }}" rows="4" required
                                    class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-lg border-slate-300 rounded-xl p-4 transition-all"
                                    placeholder="I would..."></textarea>
                                <button type="button" onclick="toggleSpeech('{{ q.id }}')"
                                    class="inline-flex items-center px-4 py-2 border border-slate-200 shadow-sm text-2xl rounded-xl text-slate-700 bg-white hover:bg-indigo-50 hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all"
                                    id="btn-{{ q.id }}" title="Record Audio">
                                    ðŸŽ¤
                                </button>
                            </div>
                            <p id="status-{{ q.id }}" class="text-sm font-bold text-indigo-600 mt-2 hidden animate-pulse flex items-center gap-2">
                                <span class="h-2 w-2 bg-indigo-600 rounded-full"></span> Listening...
                            </p>
                        </div>

                        <div class="pt-6 flex justify-between">
                            <button type="button" onclick="prevStep()" class="px-6 py-3 text-slate-500 font-bold hover:text-slate-800 transition-colors">Previous</button>
                            <button type="button" onclick="nextStep()" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">Next Question</button>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}

                <!-- Submit Section -->
                <div id="submit-section" class="hidden text-center pt-10 space-y-8 animate-in fade-in zoom-in duration-500">
                    <div class="flex flex-col items-center">
                        <div class="h-24 w-24 rounded-full bg-green-100 flex items-center justify-center mb-6">
                            <svg class="h-12 w-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-3xl font-extrabold text-slate-900 mb-2">Assessment Complete!</h3>
                        <p class="text-slate-500 text-lg max-w-md mx-auto">Click below to generate your personalized AI career insights and stream recommendations.</p>
                    </div>

                    <button type="submit" id="submit-btn"
                        class="w-full py-4 px-8 border border-transparent rounded-2xl shadow-xl text-xl font-bold text-white bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500 transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center">
                        <span id="btn-text">Get My Career Path</span>
                        <div id="btn-spinner" class="hidden ml-3">
                            <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </button>
                    <p id="loading-text" class="hidden mt-6 text-violet-600 font-bold animate-pulse text-lg">
                        AI is analyzing your profile to generate professional recommendations... This may take 10 seconds.
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Floating Premium AI Buddy Orb -->
<div id="talking-buddy" class="fixed top-24 right-8 z-[100] flex items-center justify-center w-20 h-20 pointer-events-none">
    <!-- Outer Pulse Rings -->
    <div class="pulse-ring absolute inset-0 rounded-full bg-violet-400 opacity-0"></div>
    <div class="pulse-ring absolute inset-0 rounded-full bg-indigo-400 opacity-0" style="animation-delay: 0.5s"></div>
    
    <!-- Inner Orb -->
    <div class="buddy-orb relative w-14 h-14 rounded-full bg-gradient-to-br from-violet-600 to-indigo-700 shadow-[0_0_30px_rgba(139,92,246,0.6)] flex items-center justify-center border-2 border-violet-400/30 overflow-hidden">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(255,255,255,0.2),transparent)]"></div>
        <span class="text-3xl z-10">âœ¨</span>
    </div>

    <!-- Status Indicator -->
    <div id="buddy-status" class="absolute bottom-1 right-1 h-5 w-5 bg-slate-400 rounded-full border-2 border-white shadow-lg z-[110] transition-colors duration-300"></div>
</div>

<script>
    let currentStep = 0;
    const steps = document.querySelectorAll('.question-step');
    const totalSteps = steps.length;
    const progressBar = document.getElementById('progress-bar');
    const currentStepText = document.getElementById('current-step-text');
    const totalStepsText = document.getElementById('total-steps-text');
    const buddyAvatar = document.querySelector('.buddy-avatar');
    const buddyStatus = document.getElementById('buddy-status');

    function updateProgress() {
        const percentage = (currentStep / totalSteps) * 100;
        progressBar.style.width = percentage + '%';
        
        if (currentStep < totalSteps) {
            currentStepText.innerText = currentStep + 1;
            totalStepsText.innerText = totalSteps;
        }
    }

    function showStep(index) {
        steps.forEach(step => step.classList.add('hidden'));

        if (index >= totalSteps) {
            document.getElementById('submit-section').classList.remove('hidden');
            progressBar.style.width = '100%';
            currentStepText.parentElement.innerText = "Completed";
            return;
        }

        steps[index].classList.remove('hidden');
        currentStep = index;
        updateProgress();
        
        // Cancel any previous speech when moving to new question
        window.speechSynthesis.cancel();
    }

    function handleSelection(input) {
        setTimeout(() => {
            nextStep();
        }, 400);
    }

    function nextStep() {
        // Basic validation for textareas
        const currentStepEl = steps[currentStep];
        const textarea = currentStepEl.querySelector('textarea');
        if (textarea && !textarea.value.trim()) {
            textarea.classList.add('border-red-500', 'shake');
            setTimeout(() => textarea.classList.remove('shake'), 500);
            return;
        }

        showStep(currentStep + 1);
    }

    function prevStep() {
        if (currentStep > 0) {
            showStep(currentStep - 1);
        }
    }

    function getBestVoice() {
        const voices = window.speechSynthesis.getVoices();
        // Priority: Indian English (en-IN) versions first
        return voices.find(v => v.lang === 'en-IN') ||
               voices.find(v => v.name.includes('India') || v.name.includes('Indian')) ||
               voices.find(v => v.lang.startsWith('en')) ||
               voices[0];
    }

    function speakCurrentQuestion() {
        window.speechSynthesis.cancel();
        const currentQuestion = steps[currentStep]?.querySelector('.question-title')?.innerText;
        const currentText = steps[currentStep]?.querySelector('p.italic')?.innerText;
        
        if (currentQuestion) {
            let textToSpeak = currentQuestion;
            if (currentText) textToSpeak += ". . . " + currentText;
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.voice = getBestVoice();
            utterance.rate = 1.0;
            utterance.pitch = 1.1;

            utterance.onstart = () => {
                talkingBuddy.classList.add('buddy-talking');
                buddyStatus.classList.remove('bg-slate-400');
                buddyStatus.classList.add('bg-green-400', 'shadow-[0_0_8px_#4ade80]');
            };

            utterance.onend = () => {
                talkingBuddy.classList.remove('buddy-talking');
                buddyStatus.classList.remove('bg-green-400', 'shadow-[0_0_8px_#4ade80]');
                buddyStatus.classList.add('bg-slate-400');
            };

            window.speechSynthesis.speak(utterance);
        }
    }

    // Refresh voices on load
    window.speechSynthesis.onvoiceschanged = () => getBestVoice();

    // Speech Recognition (STT) for 12th/Above
    function toggleSpeech(questionId) {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Speech recognition is not supported in this browser. Please use Chrome.");
            return;
        }

        const btn = document.getElementById(`btn-${questionId}`);
        const status = document.getElementById(`status-${questionId}`);
        const textarea = document.getElementById(questionId);

        if (btn.classList.contains('listening')) {
            if (window.recognition) window.recognition.stop();
            return;
        }

        const recognition = new webkitSpeechRecognition();
        window.recognition = recognition;
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = function () {
            btn.classList.add('listening');
            btn.classList.remove('bg-white');
            btn.classList.add('bg-red-50', 'text-red-600', 'border-red-200');
            btn.innerHTML = 'â¹ï¸';
            status.classList.remove('hidden');
        };

        recognition.onresult = function (event) {
            const transcript = event.results[0][0].transcript;
            textarea.value = (textarea.value ? textarea.value + " " : "") + transcript;
        };

        recognition.onerror = () => resetUI(questionId);
        recognition.onend = () => resetUI(questionId);
        recognition.start();
    }

    function resetUI(questionId) {
        const btn = document.getElementById(`btn-${questionId}`);
        const status = document.getElementById(`status-${questionId}`);
        btn.classList.remove('listening', 'bg-red-50', 'text-red-600', 'border-red-200');
        btn.classList.add('bg-white');
        btn.innerHTML = 'ðŸŽ¤';
        status.classList.add('hidden');
    }

    // Form submission UI
    document.getElementById('assessment-form').addEventListener('submit', function() {
        const btn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const spinner = document.getElementById('btn-spinner');
        const loadingText = document.getElementById('loading-text');

        btn.disabled = true;
        btn.classList.add('opacity-75', 'cursor-not-allowed');
        btnText.innerText = 'Analyzing Results...';
        spinner.classList.remove('hidden');
        loadingText.classList.remove('hidden');
    });

    // CSS for buddy and shake effect
    const style = document.createElement('style');
    style.innerHTML = `
        #talking-buddy { animation: orbWander 15s ease-in-out infinite alternate; }
        @keyframes orbWander { 0% { transform: translate(0, 0); } 25% { transform: translate(15px, 25px); } 50% { transform: translate(-20px, 15px); } 75% { transform: translate(10px, -20px); } 100% { transform: translate(-10px, -10px); } }
        .buddy-orb { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); animation: orbBreathe 4s ease-in-out infinite; }
        @keyframes orbBreathe { 0%, 100% { transform: scale(1); box-shadow: 0 0 25px rgba(139,92,246,0.5); } 50% { transform: scale(1.08); box-shadow: 0 0 45px rgba(139,92,246,0.8); } }
        .pulse-ring { animation: ringExpand 2.5s cubic-bezier(0, 0, 0.2, 1) infinite; visibility: hidden; }
        @keyframes ringExpand { 0% { transform: scale(0.6); opacity: 0; } 20% { opacity: 0.6; } 100% { transform: scale(2.8); opacity: 0; } }
        .buddy-talking .pulse-ring { visibility: visible; }
        .buddy-talking .buddy-orb { animation: orbVibrate 0.2s linear infinite; border-color: rgba(167, 139, 250, 0.9); }
        @keyframes orbVibrate { 0%, 100% { transform: scale(1.08) translate(0, 0); } 33% { transform: scale(1.1) translate(2px, -1px); } 66% { transform: scale(1.06) translate(-2px, 1px); } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    `;
    document.head.appendChild(style);

    // Init first step
    document.addEventListener('DOMContentLoaded', () => {
        showStep(0);
    });
</script>
{% endblock %}
