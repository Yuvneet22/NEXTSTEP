{% extends "base.html" %}

{% block title %}Find a Counsellor{% endblock %}

{% block content %}
<div class="bg-white/70 backdrop-blur-xl rounded-3xl overflow-hidden shadow-2xl border border-white/50">
    <div
        class="px-6 py-6 sm:px-8 bg-indigo-50/50 border-b border-indigo-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h3 class="text-2xl leading-6 font-bold text-slate-900">Expert Counsellors</h3>
            <p class="mt-2 max-w-2xl text-sm text-slate-500">Connect with industry experts via 1-on-1 video calls.</p>
        </div>
        <div>
            <a href="/dashboard"
                class="inline-flex items-center px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-xl text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                Back to Dashboard
            </a>
        </div>
    </div>

    <div class="px-6 py-6 sm:p-8">
        {% if counsellors %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for c in counsellors %}
            <div
                class="bg-white/80 rounded-2xl p-6 shadow-sm border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h4 class="text-xl font-bold text-slate-900">{{ c.user.full_name }}</h4>
                        <p class="text-sm font-medium text-emerald-600 mt-1">â‚¹{{ c.fee }} / Session</p>
                    </div>
                </div>

                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 mb-6">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Availability</p>
                    <p class="text-sm text-slate-700 font-medium whitespace-pre-line">{{ c.availability.get('text', 'Ask
                        for availability') if c.availability else 'Flexible' }}</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Select Date
                            & Time</label>
                        <input type="datetime-local" id="time_{{ c.user_id }}"
                            class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                    </div>

                    <button onclick="payNow('{{ c.user_id }}', '{{ c.fee }}', '{{ c.user.full_name }}')"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        Book & Pay Now
                    </button>
                    <p class="text-xs text-center text-slate-500">Video call link generated instantly after booking.</p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <h3 class="mt-2 text-lg font-bold text-slate-900">No counsellors found</h3>
            <p class="mt-1 text-sm text-slate-500">Check back soon as more experts join our platform.</p>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    async function payNow(counsellorId, fee, counsellorName) {
        const apptTime = document.getElementById(`time_${counsellorId}`).value;
        if (!apptTime) {
            alert("Please select an appointment time first.");
            return;
        }

        if (parseFloat(fee) === 0) {
            // Direct booking for free counsellors
            const freeForm = document.createElement('form');
            freeForm.method = 'POST';
            freeForm.action = `/book_free_counsellor/${counsellorId}`;

            const timeInput = document.createElement('input');
            timeInput.type = 'hidden';
            timeInput.name = 'appointment_time';
            timeInput.value = apptTime;
            freeForm.appendChild(timeInput);

            document.body.appendChild(freeForm);
            freeForm.submit();
            return;
        }

        // 1. Create order on backend
        const formData = new FormData();
        formData.append('fee', fee);

        let orderData;
        try {
            const response = await fetch(`/create_razorpay_order/${counsellorId}`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || "Server error occurred");
            }

            orderData = await response.json();
        } catch (err) {
            console.error("Order creation failed:", err);
            alert("Payment Initiation Failed: " + err.message);
            return;
        }

        // 2. Open Razorpay Checkout
        const options = {
            "key": "{{ RAZORPAY_KEY_ID }}", // This will be passed from backend if configured in app.state or similar, but for now we'll assumes it's available or we can inject it
            "amount": orderData.amount,
            "currency": orderData.currency,
            "name": "NextStep",
            "description": `Session booking with ${counsellorName}`,
            "order_id": orderData.id,
            "handler": function (response) {
                // 3. Verify payment on backend
                const verifyForm = document.createElement('form');
                verifyForm.method = 'POST';
                verifyForm.action = '/verify_payment';

                const fields = {
                    'razorpay_payment_id': response.razorpay_payment_id,
                    'razorpay_order_id': response.razorpay_order_id,
                    'razorpay_signature': response.razorpay_signature,
                    'counsellor_id': counsellorId,
                    'appointment_time': apptTime
                };

                for (const key in fields) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = fields[key];
                    verifyForm.appendChild(input);
                }

                document.body.appendChild(verifyForm);
                verifyForm.submit();
            },
            "prefill": {
                "name": "{{ user.full_name }}",
                "email": "{{ user.email }}"
            },
            "theme": {
                "color": "#4F46E5"
            }
        };

        const rzp = new Razorpay(options);
        rzp.open();
    }
</script>
{% endblock %}